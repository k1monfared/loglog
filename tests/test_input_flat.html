<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>test_input_flat</title>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --border-color: #ddd;
            --help-bg: #f0f0f0;
            --help-bg-hover: #e9e9e9;
            --help-collapsed-bg: #e0e0e0;
            --help-collapsed-hover: #d0d0d0;
            --help-text: #666;
            --help-collapsed-text: #888;
            --triangle-color: #666;
            --todo-pending: #e74c3c;
            --todo-completed: #95a5a6;
            --focused-bg: rgba(52, 152, 219, 0.05);
            --focused-border: #3498db;
        }
        
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --border-color: #444;
            --help-bg: #2c2c2c;
            --help-bg-hover: #3a3a3a;
            --help-collapsed-bg: #404040;
            --help-collapsed-hover: #4a4a4a;
            --help-text: #aaa;
            --help-collapsed-text: #888;
            --triangle-color: #aaa;
            --todo-pending: #e74c3c;
            --todo-completed: #7f8c8d;
            --focused-bg: rgba(52, 152, 219, 0.03);
            --focused-border: #5dade2;
        }
        
        body {
            font-family: monospace;
            margin: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        
        h1 {
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        ul {
            margin: 0;
            padding-left: 20px;
            list-style: none;
        }
        
        li {
            margin: 2px 0;
            position: relative;
        }
        
        .triangle {
            display: inline-block;
            width: 0;
            height: 0;
            margin-right: 5px;
            cursor: pointer;
            transition: transform 0.2s;
            user-select: none;
        }
        
        .triangle.expanded {
            border-left: 6px solid var(--triangle-color);
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            transform: rotate(90deg);
        }
        
        .triangle.collapsed {
            border-left: 6px solid var(--triangle-color);
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            transform: rotate(0deg);
        }
        
        .item-content {
            display: inline;
        }
        
        .children {
            margin-left: 0px;
        }
        
        .children.hidden {
            display: none;
        }
        
        .todo-completed {
            text-decoration: line-through;
            color: var(--todo-completed);
        }
        
        .todo-pending {
            color: var(--todo-pending);
            font-weight: bold;
        }
        
        .no-children {
            margin-left: 11px;
        }
        
        .controls {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .keyboard-help {
            font-size: 12px;
            color: var(--help-text);
            background: var(--help-bg);
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
            max-width: 300px;
            border: 1px solid var(--border-color);
            z-index: 1000;
            position: relative;
        }
        
        .keyboard-help.collapsed {
            padding: 6px 9px;
            font-size: 16px;
            background: var(--help-collapsed-bg);
            color: var(--help-collapsed-text);
            max-width: 25px;
            font-weight: bold;
        }
        
        .keyboard-help:hover {
            background: var(--help-bg-hover);
        }
        
        .keyboard-help.collapsed:hover {
            background: var(--help-collapsed-hover);
        }
        
        .theme-toggle {
            background: var(--help-bg);
            border: 1px solid var(--border-color);
            color: var(--help-text);
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-family: monospace;
            user-select: none;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            background: var(--help-bg-hover);
        }
        
        .focused-branch {
            background-color: var(--focused-bg);
            border-left: 3px solid transparent;
            padding-left: 8px;
            border-radius: 2px;
            transition: border-color 0.2s ease;
        }
        
        .focused-branch.active {
            border-left-color: var(--focused-border);
        }
        
        .keyboard-focused {
            background-color: var(--focused-bg);
            border-left: 3px solid var(--focused-border);
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button class="theme-toggle" id="themeToggle">◐</button>
        <div class="keyboard-help collapsed" id="keyboardHelp" title="Click to show keyboard shortcuts">
            ?
        </div>
    </div>
    <h1>test_input_flat</h1>
    <ul class="root-list">
        <li data-level="2">
            <span class="no-children item-content ">Item A
</span>
        </li>
        <li data-level="2">
            <span class="no-children item-content ">Item B  
</span>
        </li>
        <li data-level="2">
            <span class="no-children item-content ">Item C
</span>
        </li>
        <li data-level="2">
            <span class="no-children item-content ">Item D
</span>
        </li>
        <li data-level="2">
            <span class="no-children item-content ">Item E</span>
        </li>

    </ul>
    
    <script>
        let currentFocusedItem = null;
        let currentFocusedBranch = [];
        let helpVisible = false;
        let isDarkMode = false;
        let allItems = [];
        
        // Theme toggle functionality
        document.getElementById('themeToggle').addEventListener('click', function() {
            const body = document.body;
            const button = document.getElementById('themeToggle');
            
            isDarkMode = !isDarkMode;
            
            if (isDarkMode) {
                body.setAttribute('data-theme', 'dark');
                button.innerHTML = '○';
            } else {
                body.removeAttribute('data-theme');
                button.innerHTML = '●';
            }
            
            // Store preference
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        });
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.getElementById('themeToggle').click();
            }
            
            // Initialize items list for keyboard navigation
            allItems = Array.from(document.querySelectorAll('li[data-level]'));
            
            // Add invisible borders to all items to prevent text movement
            allItems.forEach(item => {
                item.classList.add('focused-branch');
            });
            
            // Set first item as focused by default
            if (allItems.length > 0) {
                setFocusedItem(allItems[0]);
            }
        });
        
        // Help toggle functionality
        document.getElementById('keyboardHelp').addEventListener('click', function() {
            const helpDiv = document.getElementById('keyboardHelp');
            helpVisible = !helpVisible;
            
            if (helpVisible) {
                helpDiv.classList.remove('collapsed');
                helpDiv.innerHTML = `Ctrl+1-9: Fold to level | Ctrl+0: Unfold all<br>
                    Ctrl+Alt+1-9: Focus mode (fold others to level)<br>
                    Up/Down: Navigate visible | Left/Right: Hierarchical<br>
                    Enter/Space: Toggle fold | Left: Always fold<br>
                    <small style="color: #999;">Click to hide</small>`;
                helpDiv.title = '';
            } else {
                helpDiv.classList.add('collapsed');
                helpDiv.innerHTML = `?`;
                helpDiv.title = 'Click to show keyboard shortcuts';
            }
        });
        
        // Click handler for triangles
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('triangle')) {
                const li = e.target.closest('li');
                const children = li.querySelector('.children');
                
                if (children) {
                    children.classList.toggle('hidden');
                    e.target.classList.toggle('expanded');
                    e.target.classList.toggle('collapsed');
                }
            }
        });
        
        // Keyboard navigation functions
        function setFocusedItem(item) {
            // Clear previous focus
            if (currentFocusedItem) {
                currentFocusedItem.classList.remove('keyboard-focused');
                // Clear branch highlighting
                currentFocusedBranch.forEach(branchItem => {
                    branchItem.classList.remove('active');
                });
            }
            
            currentFocusedItem = item;
            
            if (item) {
                item.classList.add('keyboard-focused');
                
                // Build branch path and highlight
                currentFocusedBranch = getBranchPath(item);
                currentFocusedBranch.forEach(branchItem => {
                    branchItem.classList.add('active');
                });
                
                // Scroll item into view if needed
                item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        function getVisibleItems() {
            return allItems.filter(item => {
                // Check if item is visible (not inside a folded section)
                let current = item;
                while (current && current.hasAttribute('data-level')) {
                    const parentUl = current.parentElement;
                    if (parentUl && parentUl.classList.contains('children') && parentUl.classList.contains('hidden')) {
                        return false;
                    }
                    // Move up to parent li
                    if (parentUl && parentUl.classList.contains('children')) {
                        current = parentUl.parentElement;
                    } else {
                        break;
                    }
                }
                return true;
            });
        }
        
        function navigateUp() {
            const visibleItems = getVisibleItems();
            const currentIndex = currentFocusedItem ? visibleItems.indexOf(currentFocusedItem) : -1;
            if (currentIndex > 0) {
                setFocusedItem(visibleItems[currentIndex - 1]);
            } else if (visibleItems.length > 0) {
                setFocusedItem(visibleItems[0]);
            }
        }
        
        function navigateDown() {
            const visibleItems = getVisibleItems();
            const currentIndex = currentFocusedItem ? visibleItems.indexOf(currentFocusedItem) : -1;
            if (currentIndex < visibleItems.length - 1) {
                setFocusedItem(visibleItems[currentIndex + 1]);
            } else if (visibleItems.length > 0) {
                setFocusedItem(visibleItems[visibleItems.length - 1]);
            }
        }
        
        function navigateRight() {
            if (!currentFocusedItem) return;
            
            const children = currentFocusedItem.querySelector('.children');
            const triangle = currentFocusedItem.querySelector('.triangle');
            
            if (children) {
                if (children.classList.contains('hidden')) {
                    // Current item is folded, unfold it and go to first child
                    children.classList.remove('hidden');
                    triangle.classList.remove('collapsed');
                    triangle.classList.add('expanded');
                    
                    // Find first child
                    const firstChild = children.querySelector('li[data-level]');
                    if (firstChild) {
                        setFocusedItem(firstChild);
                    }
                } else {
                    // Current item is already unfolded, go to first child
                    const firstChild = children.querySelector('li[data-level]');
                    if (firstChild) {
                        setFocusedItem(firstChild);
                    } else {
                        // No children, go to next item in list
                        navigateToNextInHierarchy();
                    }
                }
            } else {
                // No children, go to next item in hierarchy
                navigateToNextInHierarchy();
            }
        }
        
        function navigateLeft() {
            if (!currentFocusedItem) return;
            
            const children = currentFocusedItem.querySelector('.children');
            const triangle = currentFocusedItem.querySelector('.triangle');
            
            if (children && !children.classList.contains('hidden')) {
                // Current item is unfolded, fold it and stay on same item
                children.classList.add('hidden');
                triangle.classList.remove('expanded');
                triangle.classList.add('collapsed');
            } else {
                // Current item is folded or has no children, go to parent
                const parentUl = currentFocusedItem.parentElement;
                if (parentUl && parentUl.classList.contains('children')) {
                    const parentLi = parentUl.parentElement;
                    if (parentLi && parentLi.hasAttribute('data-level')) {
                        setFocusedItem(parentLi);
                        
                        // Also fold the parent after navigating to it
                        const parentChildren = parentLi.querySelector('.children');
                        const parentTriangle = parentLi.querySelector('.triangle');
                        if (parentChildren && !parentChildren.classList.contains('hidden')) {
                            parentChildren.classList.add('hidden');
                            parentTriangle.classList.remove('expanded');
                            parentTriangle.classList.add('collapsed');
                        }
                    }
                }
            }
        }
        
        function navigateToNextInHierarchy() {
            const currentIndex = allItems.indexOf(currentFocusedItem);
            if (currentIndex < allItems.length - 1) {
                setFocusedItem(allItems[currentIndex + 1]);
            }
        }
        
        function toggleCurrentItem() {
            if (currentFocusedItem) {
                const triangle = currentFocusedItem.querySelector('.triangle');
                const children = currentFocusedItem.querySelector('.children');
                
                if (triangle && children) {
                    children.classList.toggle('hidden');
                    triangle.classList.toggle('expanded');
                    triangle.classList.toggle('collapsed');
                }
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey) {
                const key = e.key;
                
                if (key === '0') {
                    // Unfold everything
                    e.preventDefault();
                    unfoldAll();
                } else if (key >= '1' && key <= '9') {
                    const level = parseInt(key);
                    
                    if (e.altKey) {
                        // Focus mode: fold others to level, keep current branch unfolded
                        e.preventDefault();
                        focusMode(level + 1); // Adjust for 0-based vs 1-based indexing
                    } else {
                        // Regular fold to specific level
                        e.preventDefault();
                        foldToLevel(level + 1); // Adjust for 0-based vs 1-based indexing
                    }
                }
            } else {
                // Navigation keys
                switch(e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        navigateUp();
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        navigateDown();
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        navigateRight();
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        navigateLeft();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        toggleCurrentItem();
                        break;
                    case ' ':  // Spacebar
                        e.preventDefault();
                        toggleCurrentItem();
                        break;
                }
            }
        });
        
        function unfoldAll() {
            const allChildren = document.querySelectorAll('.children');
            const allTriangles = document.querySelectorAll('.triangle');
            
            allChildren.forEach(children => children.classList.remove('hidden'));
            allTriangles.forEach(triangle => {
                triangle.classList.remove('collapsed');
                triangle.classList.add('expanded');
            });
        }
        
        function foldToLevel(maxLevel) {
            const allItems = document.querySelectorAll('li[data-level]');
            
            allItems.forEach(li => {
                const level = parseInt(li.getAttribute('data-level'));
                const children = li.querySelector('.children');
                const triangle = li.querySelector('.triangle');
                
                if (children && triangle) {
                    if (level >= maxLevel) {
                        // Fold items at or beyond max level
                        children.classList.add('hidden');
                        triangle.classList.remove('expanded');
                        triangle.classList.add('collapsed');
                    } else {
                        // Unfold items below max level
                        children.classList.remove('hidden');
                        triangle.classList.remove('collapsed');
                        triangle.classList.add('expanded');
                    }
                }
            });
        }
        
        function getBranchPath(targetLi) {
            const path = [];
            let current = targetLi;
            
            while (current && current.hasAttribute('data-level')) {
                path.unshift(current);
                
                // Find parent li by traversing up the DOM
                const parentUl = current.parentElement;
                if (parentUl && parentUl.classList.contains('children')) {
                    current = parentUl.parentElement;
                } else {
                    break;
                }
            }
            
            return path;
        }
        
        function focusMode(maxLevel) {
            if (!currentFocusedItem || currentFocusedBranch.length === 0) {
                // No item focused, fall back to regular fold
                foldToLevel(maxLevel);
                return;
            }
            
            const allItemsQuery = document.querySelectorAll('li[data-level]');
            const focusedSet = new Set(currentFocusedBranch);
            
            allItemsQuery.forEach(li => {
                const level = parseInt(li.getAttribute('data-level'));
                const children = li.querySelector('.children');
                const triangle = li.querySelector('.triangle');
                
                if (children && triangle) {
                    const isInFocusedBranch = focusedSet.has(li);
                    
                    if (isInFocusedBranch) {
                        // Keep focused branch expanded
                        children.classList.remove('hidden');
                        triangle.classList.remove('collapsed');
                        triangle.classList.add('expanded');
                    } else if (level >= maxLevel) {
                        // Fold non-focused items at or beyond max level
                        children.classList.add('hidden');
                        triangle.classList.remove('expanded');
                        triangle.classList.add('collapsed');
                    } else {
                        // Unfold non-focused items below max level
                        children.classList.remove('hidden');
                        triangle.classList.remove('collapsed');
                        triangle.classList.add('expanded');
                    }
                }
            });
        }
        
    </script>
</body>
</html>